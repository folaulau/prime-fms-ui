<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
<head>
    <title>Slins Mapping</title>

    <!-- <link rel="stylesheet" href="/assets/primeui/themes/ui-lightness/theme.css" /> -->
    <!-- <link rel="stylesheet" href="/assets/primeui/primeui.css" /> -->
    <link rel="stylesheet" href="/assets/primeicon/primeicons.css" />
    <link rel="stylesheet" href="/assets/primeui/primeui.min.css" />

    <script type="text/javascript" src="/assets/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/assets/primeui/primeui.min.js"></script>

    <!-- <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" />-->
    <!-- <link rel="stylesheet" href="/assets/primeui/themes/glass-x/theme.css" /> -->
    <link rel="stylesheet" href="/assets/primeui/themes/omega/theme.css" />
    <!-- <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" /> -->
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-grid.min.css" />
    <!-- <script type="text/javascript" src="/assets/bootstrap/css/bootstrap-grid.css"></script>  -->
    <!-- <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.min.js"></script> 
    <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>  -->

    <style>

        /* Id */
        #currentSlinsTable th:nth-child(1) {
            width: 4%;
        }

        /* Charge Code */
        #currentSlinsTable th:nth-child(2) {
            width: 20%;
        }

        /* SLIN */
        #currentSlinsTable th:nth-child(3) {
            width: 6%;
        }

        /* TPS ID */
        #currentSlinsTable th:nth-child(4) { 
            width: 6%;
        }

        /* TPS Name */
        #currentSlinsTable th:nth-child(5) { 
            width: 20%;
        }

        /* Notes */
        #currentSlinsTable th:nth-child(6) { 
            width: 28%;
        }

        /* Effective Date */
        #currentSlinsTable th:nth-child(7) { 
            width: 8%;
        }

        /* Closed Date */
        #currentSlinsTable th:nth-child(8) { 
            width: 8%;
        }

        .updated-row {
            background-color: red !important;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="row">
        <div class="col-12 text-center">
            <h2>SLIN to TPS ID Mapping</h2>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-6">
            <button id="addButton" type="button">Add</button> <button id="saveButton" type="button">Save</button>
        </div>
        <div class="col-6">
            <div id="apiMessage"></div>  
        </div>
        
    </div>

    <div class="row">
        <div class="col-12">
            <p id="currentSlinsTable"></p>
        </div>
    </div>
</div>




<script type="text/javascript">


    $(document).ready(function(){
        // call api to get all customers

        $('#apiMessage').puimessages();

        $('#addButton').puibutton();

        $('#in').puiinputtext();

        $('#slinAddUpdateRow').puifieldset();

        $('#saveButton').puibutton();

        var columnHeaders = [
            {
                field: "id",
                headerText: "Id",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "chargeCode",
                headerText: "Charge Code",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "slin",
                headerText: "SLIN",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "tpsId",
                headerText: "TPS ID",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "tpsName",
                headerText: "TPS Name",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "notes",
                headerText: "Notes",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "effectiveDate",
                headerText: "Effective Date",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            },
            {
                field: "closedDate",
                headerText: "Closed Date",
                sortable: true,
                filter: true,
                filterMatchMode: 'contains',
                editor: 'input'
            }
        ];

        var slinRows = [];

        var pageNumber = 0;
        var pageSize = 100;

        loadData(pageNumber, pageSize);

        var latestId = 0;
        var pageResults = {};

        function loadData(pageNumber, pageSize){
            var customers = [];
            var pagination = {
                pageNumber: pageNumber,
                pageSize: pageSize
            };
            // $.ajax({
            //     url: 'http://localhost:8092/api/slin-current/search',
            //     type: 'POST',
            //     contentType: 'application/json',
            //     data: JSON.stringify(pagination),
            //     success: function(data) {
            //         console.log('data');
            //         console.log(data);
            //         slinRows = data.content;
            //         pageResults = data;
            //         latestId = Math.max(...slinRows.map(slinRow => slinRow.id));
            //         console.log(`latestId: `, latestId); // Output: 5

            //         displayTable(pageNumber, pageSize);
            //     },
            //     error: function(xhr, status, error) {
            //         console.error('Error:', error);
            //     }
            // });

            slinRows = backendData;
            displayTable(pageNumber, pageSize);
        }

        var updatedRows = [];

        function displayTable( pageNumber, pageSize){
            console.log('slinRows');
            console.log(slinRows);

            $('#currentSlinsTable').puidatatable({
                responsive: true,
                columns: columnHeaders,
                datasource: slinRows,
                paginator: { rows: 10 },
                selectionMode: 'single',
                editMode: 'cell',
                cellEdit: hanldeCellEdit
            });
        }

        function hanldeCellEdit(event, data){
            console.log("hanldeCellEdit");
            console.log(`event `, event);
            console.log(`data `, data);

            // Extract the row data and ID
            const editedRow = data.data;
            const rowId = editedRow.id;

            console.log("rowId:", rowId);

            // Check if the row already exists in updatedRows
            const existingIndex = updatedRows.findIndex(row => row.id === rowId);

            console.log("existingIndex:", existingIndex);

            if (existingIndex >= 0) {
                // Replace the existing entry
                updatedRows[existingIndex] = editedRow;
                console.log(`Replaced existing row at index ${existingIndex} in updatedRows.`);
            } else {
                // Add the new row
                updatedRows.push(editedRow);
                console.log("Added new row to updatedRows.");
            }

            // Use the event's dataTable property to locate the row (event.rowIndex)
            const rowIndex = event.rowIndex; // Row index from the event
            console.log("rowIndex:", rowIndex);
            const tableRows = $('#currentSlinsTable tbody tr'); // All rows in the table
            console.log("tableRows:", tableRows);
            const tableRow = tableRows[3]; // Find the corresponding row by index

            if (tableRow) {
                $(tableRow).addClass('updated-row'); // Add the `updated-row` class
            }

            console.log("Updated updatedRows:", updatedRows);

        }

        function showMessage(type, summary, detail){
            $('#apiMessage').puimessages('show', type, {summary: summary, detail: detail});

            // Hide the message after 2 seconds
            setTimeout(function () {
                $('#apiMessage').puimessages('clear');
            }, 2000); // 2000 milliseconds = 2 seconds
        }

        $("#saveButton").click(function(){

            console.log('save updatedRows', updatedRows);

            if(updatedRows.length === 0){
                showMessage('warn', 'No data to save', '');
                return;
            }

            updatedRows = updatedRows.map(row => {
                if (String(row.id).startsWith("New Id")) {
                    row.id = null;
                }
                return row;
            });

            addUpdate(updatedRows);
        });

        function addUpdate(rows){
            console.log("rows", rows);
            var payload = rows;
            $.ajax({
                url: 'http://localhost:8092/api/slin-current/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(data) {
                    console.log('newly saved data', data);
                    showMessage('info', 'Successfully saved data', '');
                    loadData(0, 10);
                    updatedRows = [];
                }
            });
        }

        $("#addButton").click(function(){
            console.log('add button clicked');
            latestId++;
            slinRows.unshift({
                id: 'New Id '+latestId,
                chargeCode: '',
                slin: '',
                tpsId: '',
                tpsName: '',
                notes: '',
                effDate: '',
                closedDate: ''
            });

            displayTable();
            
        });

        

        // displayTable();
    });


var backendData = [
            {
            "id": 64,
            "chargeCode": "4118194.0002.2801.2801BM.426",
            "slin": "2801BM",
            "tpsId": "426",
            "tpsName": "1.0 HARDWARE/MAJOR EQUIP",
            "notes": "Move to here from 2801BH Effective 10/3/24",
            "effectiveDate": "2024-10-03"
            },
            {
            "id": 63,
            "chargeCode": "4118194.0002.2801.2801BW.460",
            "slin": "2801BW",
            "tpsId": "460",
            "tpsName": "BMD 5.1.5 ",
            "notes": "Move to here from 2801AP Effective 10/12/24",
            "effectiveDate": "2024-10-12"
            },
            {
            "id": 62,
            "chargeCode": "4118194.0002.2801.2801BW.458",
            "slin": "2801BW",
            "tpsId": "458",
            "tpsName": "BMD 6.0.1",
            "notes": "Move to here from 2801AP Effective 10/12/24",
            "effectiveDate": "2024-10-12"
            },
            {
            "id": 61,
            "chargeCode": "4118194.0002.2801.2801BW.453",
            "slin": "2801BW",
            "tpsId": "453",
            "tpsName": "GUAM MODELING DEVEL SUP",
            "notes": "Move to here from 2801AP Effective 10/12/24",
            "effectiveDate": "2024-10-12"
            },
            {
            "id": 60,
            "chargeCode": "4118194.0002.2801.2801BW.452",
            "slin": "2801BW",
            "tpsId": "452",
            "tpsName": "GUAM SITE ENGINEERING",
            "notes": "Move to here from 2801AP Effective 10/12/24",
            "effectiveDate": "2024-10-12"
            },
            {
            "id": 59,
            "chargeCode": "4118194.0002.2801.2801BU.422",
            "slin": "2801BU",
            "tpsId": "422",
            "tpsName": "DDG Waterfront ILS 3",
            "notes": "Project number re-opened",
            "effectiveDate": "2024-10-17"
            },
            {
            "id": 58,
            "chargeCode": "4118194.0002.2801.2801BU.466",
            "slin": "2801BU",
            "tpsId": "466",
            "tpsName": "CG ILS Backfit",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 57,
            "chargeCode": "4118194.0002.2801.2801BU.465",
            "slin": "2801BU",
            "tpsId": "465",
            "tpsName": "USN Harvesting",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 56,
            "chargeCode": "4118194.0002.2801.2801AH.464",
            "slin": "2801AH",
            "tpsId": "464",
            "tpsName": "Glide Phase Intercept Sup",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 55,
            "chargeCode": "4118194.0002.2801.2801AX.463",
            "slin": "2801AX",
            "tpsId": "463",
            "tpsName": "BMD Fleet Sustainment",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 54,
            "chargeCode": "4118194.0002.2801.2801AJ.462",
            "slin": "2801AJ",
            "tpsId": "462",
            "tpsName": "BMD 5.4/4.1 Cert PH2",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 53,
            "chargeCode": "4118194.0002.2801.2801AM.461",
            "slin": "2801AM",
            "tpsId": "461",
            "tpsName": "BMD 5.1.6",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 52,
            "chargeCode": "4118194.0002.2801.2801BV.459",
            "slin": "2801BV",
            "tpsId": "459",
            "tpsName": "BMD 5.1 SBT INC 2/3",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 51,
            "chargeCode": "4118194.0002.2801.2801AM.457",
            "slin": "2801AM",
            "tpsId": "457",
            "tpsName": "BMD 6M",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 50,
            "chargeCode": "4118194.0002.2801.2801AL.456",
            "slin": "2801AL",
            "tpsId": "456",
            "tpsName": "MDA MILSTRIP",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 49,
            "chargeCode": "4118194.0002.2801.2801AM.455",
            "slin": "2801AM",
            "tpsId": "455",
            "tpsName": "BMD IN-SERVICE",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 48,
            "chargeCode": "4118194.0002.2801.2801AL.454",
            "slin": "2801AL",
            "tpsId": "454",
            "tpsName": "GUAM SYSTEM ENG SUP",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 47,
            "chargeCode": "4118194.0002.2801.2801AH.451",
            "slin": "2801AH",
            "tpsId": "451",
            "tpsName": "GUAM WS DEVEL ENG",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 46,
            "chargeCode": "4118194.0002.2801.2801BS.450",
            "slin": "2801BS",
            "tpsId": "450",
            "tpsName": "AA Japan",
            "effectiveDate": "2024-09-28"
            },
            {
            "id": 45,
            "chargeCode": "4118194.0002.2801.2801AD.449",
            "slin": "2801AD",
            "tpsId": "449",
            "tpsName": "SSDS  (RDT2)",
            "effectiveDate": "2024-09-28"
            }
        ];

</script>
</body>
</html>