<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
<head>
    <title>Slins Mapping</title>

    <!-- <link rel="stylesheet" href="/assets/primeui/themes/ui-lightness/theme.css" /> -->
    <!-- <link rel="stylesheet" href="/assets/primeui/primeui.css" /> -->
    <link rel="stylesheet" href="/assets/primeicon/primeicons.css" />
    <link rel="stylesheet" href="/assets/primeui/primeui.min.css" />

    <script type="text/javascript" src="/assets/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/jquery/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/assets/primeui/primeui.min.js"></script>

    <!-- <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" />-->
    <!-- <link rel="stylesheet" href="/assets/primeui/themes/glass-x/theme.css" /> -->
    <link rel="stylesheet" href="/assets/primeui/themes/omega/theme.css" />
    <!-- <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css" /> -->
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-grid.min.css" />
    <!-- <script type="text/javascript" src="/assets/bootstrap/css/bootstrap-grid.css"></script>  -->
    <!-- <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.min.js"></script> 
    <script type="text/javascript" src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>  -->

    <style>

        /* employee name */
        #currentSlinsTable th:nth-child(1) {
            width: 15%;
        }

        /* current rate */
        #currentSlinsTable th:nth-child(2) {
            width: 5%;
        }

        /* total assigned hours */
        #currentSlinsTable th:nth-child(3) {
            width: 10%;
        }

        /* remaining hours */
        #currentSlinsTable th:nth-child(4) { 
            width: 10%;
        }

        /* 1st tps */
        #currentSlinsTable th:nth-child(5) { 
            width: 2%;
        }

        /* 2nd tps */
        #currentSlinsTable th:nth-child(6) { 
            width: 2%;
        }

        /* Effective Date */
        #currentSlinsTable th:nth-child(7) { 
            width: 2%;
        }

        /* Closed Date */
        #currentSlinsTable th:nth-child(8) { 
            width: 2%;
        }

        .updated-row {
            background-color: red !important;
        }
    </style>
</head>
<body>

<div class="ms-5 me-5">
    
    <div class="row">
        <div class="col-12 text-center">
            <h2>Monthly Budget</h2>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-6">
          <button id="saveButton" type="button">Save</button>
        </div>
        <div class="col-6">
            <div id="apiMessage"></div>  
        </div>
        
    </div>

    <div class="row">
        <div class="col-12">
            <p id="currentSlinsTable"></p>
        </div>
    </div>
</div>




<script type="text/javascript">


    $(document).ready(function(){
        // call api to get all customers

        $('#apiMessage').puimessages();

        $('#addButton').puibutton();

        $('#in').puiinputtext();

        $('#slinAddUpdateRow').puifieldset();

        $('#saveButton').puibutton();

        var columnHeaders = [
            {
                field: "employeeName",
                headerText: "Employee",
                sortable: true
            },
            {
                field: "currentRate",
                headerText: "Current Rate",
                sortable: true
            },
            {
                field: "totalAssignedHours",
                headerText: "Total Assigned",
                sortable: true,
                editor: 'input'
            },
            {
                field: "remainingHours",
                headerText: "Remaining Hours",
                sortable: true
            },
            {
                field: "tps400",
                headerText: "400",
                sortable: true,
                editor: 'input'
            },
            {
                field: "tps401",
                headerText: "401",
                sortable: true,
                editor: 'input'
            },
            {
                field: "tps402",
                headerText: "402",
                sortable: true,
                editor: 'input'
            },
            {
                field: "tps403",
                headerText: "403",
                sortable: true,
                editor: 'input'
            }
        ];

        var slinRows = [];

        var pageNumber = 0;
        var pageSize = 100;

        loadData(pageNumber, pageSize);

        var latestId = 0;
        var pageResults = {};

        function loadData(pageNumber, pageSize){
            var customers = [];
            var pagination = {
                pageNumber: pageNumber,
                pageSize: pageSize
            };
            // $.ajax({
            //     url: 'http://localhost:8092/api/slin-current/search',
            //     type: 'POST',
            //     contentType: 'application/json',
            //     data: JSON.stringify(pagination),
            //     success: function(data) {
            //         console.log('data');
            //         console.log(data);
            //         slinRows = data.content;
            //         pageResults = data;
            //         latestId = Math.max(...slinRows.map(slinRow => slinRow.id));
            //         console.log(`latestId: `, latestId); // Output: 5

            //         displayTable(pageNumber, pageSize);
            //     },
            //     error: function(xhr, status, error) {
            //         console.error('Error:', error);
            //     }
            // });

            slinRows = backendData;
            latestId = Math.max(...slinRows.map(slinRow => slinRow.id));
            displayTable(pageNumber, pageSize);
        }

        var updatedRows = [];

        function displayTable( pageNumber, pageSize){
            console.log('slinRows');
            console.log(slinRows);

            $('#currentSlinsTable').puidatatable({
                responsive: true,
                columns: columnHeaders,
                datasource: slinRows,
                paginator: { rows: 10 },
                editMode: 'cell',
                cellEdit: hanldeCellEdit
            });
        }

        function isUnchangedRow(obj) {
            for (let key in obj) {
                if (obj.hasOwnProperty(key)) { // Ensure it's a direct property of the object
                    const field = obj[key];
                    if (field.initialValue !== field.value) {
                        return false; // If any field has a different value, return false
                    }
                }
            }
            return true; // If all pairs are equal, return true
        }

        var updatedRowData = {};

        function updateRowData(rowId, column, oldValue, newValue){
            let row = updatedRowData[rowId];
            if(row === undefined){
                row = {};
            }

            if(row[column] === undefined){
                row[column] = {};
                row[column]['initialValue'] = oldValue;
            }

            let initialValue = row[column]['initialValue'];

            console.log("initialValue", initialValue);
            console.log("newValue", newValue);

            row[column]['value'] = newValue;

            if(initialValue === newValue){
                // no change
                return !isUnchangedRow(row);
            }
            
            updatedRowData[rowId] = row;

            console.log("row", row);

            return true;
        }


        function hanldeCellEdit(event, data){
            console.log("hanldeCellEdit");
            console.log(`event `, event);
            console.log(`data `, data);

            // Extract the row data and ID
            const editedRow = data.data;
            const rowId = editedRow.id;

            // Check if the row already exists in updatedRows
            const existingIndex = updatedRows.findIndex(row => row.id === rowId);

            console.log("existingIndex:", existingIndex);

            if (existingIndex >= 0) {
                // Replace the existing entry
                updatedRows[existingIndex] = editedRow;
                console.log(`Replaced existing row at index ${existingIndex} in updatedRows.`);
            } else {
                // Add the new row
                updatedRows.push(editedRow);
                console.log("Added new row to updatedRows.");
            }

            const table = $('#currentSlinsTable'); // Ensure this matches your table's ID or selector
            const tableRows = table.find('tbody tr'); // Get all rows in the table

            const matchingRow = tableRows.filter((index, row) => {
                // console.log("row", row);
                // console.log("$row", $(row));
                const firstCell = $(row).find('td:first');
                // console.log("firstCell", firstCell);
                // console.log("firstCell.text()", firstCell.text());
                id = firstCell.text().replace(/\D/g, ""); // Extract the ID from the first cell
                return id === String(editedRow.id); // Match the `id` attribute with the edited row ID
            });

            let isUpdated = updateRowData(rowId, data.field, data.oldValue, data.newValue);

            console.log("isUpdated ", isUpdated);

            if (isUpdated && matchingRow.length > 0) {
                $(matchingRow).addClass('updated-row'); // Add the `updated-row` class
                console.log("Row highlighted:", matchingRow);
            } else {
                $(matchingRow).removeClass('updated-row');
                console.warn("No matching row found for ID:", editedRow.id);
            }

            console.log("Updated updatedRows:", updatedRows);

        }

        function showMessage(type, summary, detail){
            $('#apiMessage').puimessages('show', type, {summary: summary, detail: detail});

            // Hide the message after 2 seconds
            setTimeout(function () {
                $('#apiMessage').puimessages('clear');
            }, 2000); // 2000 milliseconds = 2 seconds
        }

        $("#saveButton").click(function(){

            console.log('save updatedRows', updatedRows);

            if(updatedRows.length === 0){
                showMessage('warn', 'No data to save', '');
                return;
            }

            updatedRows = updatedRows.map(row => {
                if (String(row.id).startsWith("New Id")) {
                    row.id = null;
                }
                return row;
            });

            addUpdate(updatedRows);
        });

        function addUpdate(rows){
            console.log("rows", rows);
            var payload = rows;
            $.ajax({
                url: 'http://localhost:8092/api/slin-current/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(data) {
                    console.log('newly saved data', data);
                    showMessage('info', 'Successfully saved data', '');
                    loadData(0, 10);
                    updatedRows = [];
                }
            });
        }

        $("#addButton").click(function(){
            console.log('add button clicked');
            latestId++;
            slinRows.unshift({
                id: 'New Id '+latestId,
                chargeCode: '',
                slin: '',
                tpsId: '',
                tpsName: '',
                notes: '',
                effDate: '',
                closedDate: ''
            });

            displayTable();
            
        });

        

        // displayTable();
    });


    var backendData = [
      {
        "id": 1,
        "employeeName": "Alexander, Chad",
        "currentRate": "$76.18",
        "totalAssignedHours": 40,
        "remainingHours": 120,
        "tps400": 10,
        "tps401": 10,
        "tps402": 10,
        "tps403": 10,
        "tps403": 0
      },
      {
        "id": 2,
        "employeeName": "Aron, Ben (Isreal)",
        "currentRate": "$55.48",
        "totalAssignedHours": 0,
        "remainingHours": 160,
        "tps400": 0,
        "tps401": 0,
        "tps402": 0,
        "tps403": 0,
        "tps403": 0
      }
    ];


</script>
</body>
</html>